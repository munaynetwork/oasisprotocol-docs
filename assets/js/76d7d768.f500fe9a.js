"use strict";(self.webpackChunkdocs_oasis_dev=self.webpackChunkdocs_oasis_dev||[]).push([[8646],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=d(n),m=i,h=c["".concat(l,".").concat(m)]||c[m]||u[m]||o;return n?a.createElement(h,r(r({ref:t},p),{},{components:n})):a.createElement(h,r({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var d=2;d<o;d++)r[d]=n[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1477:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return u}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],s={},l="Set up Trusted Execution Environment (TEE)",d={unversionedId:"run-a-node/prerequisites/set-up-trusted-execution-environment-tee",id:"run-a-node/prerequisites/set-up-trusted-execution-environment-tee",title:"Set up Trusted Execution Environment (TEE)",description:"In case the ParaTime you want to run does not require the use of a TEE (e.g.",source:"@site/docs/general/run-a-node/prerequisites/set-up-trusted-execution-environment-tee.md",sourceDirName:"run-a-node/prerequisites",slug:"/run-a-node/prerequisites/set-up-trusted-execution-environment-tee",permalink:"/general/run-a-node/prerequisites/set-up-trusted-execution-environment-tee",draft:!1,editUrl:"https://github.com/oasisprotocol/docs.oasis.dev/edit/main/docs/general/run-a-node/prerequisites/set-up-trusted-execution-environment-tee.md",tags:[],version:"current",lastUpdatedAt:1656660481,formattedLastUpdatedAt:"7/1/2022",frontMatter:{},sidebar:"docs",previous:{title:"System Configuration",permalink:"/general/run-a-node/prerequisites/system-configuration"},next:{title:"Set Up Your Node",permalink:"/general/run-a-node/set-up-your-node/"}},p={},u=[{value:"Ensure Clock Synchronization",id:"ensure-clock-synchronization",level:2},{value:"Install SGX Linux Driver",id:"install-sgx-linux-driver",level:2},{value:"Ubuntu 18.04/16.04",id:"ubuntu-18041604",level:3},{value:"Fedora 34/33",id:"fedora-3433",level:3},{value:"Other Distributions",id:"other-distributions",level:3},{value:"Verification",id:"verification",level:3},{value:"Ensure <code>/dev</code> is NOT Mounted with the <code>noexec</code> Option",id:"ensure-dev-is-not-mounted-with-the-noexec-option",level:2},{value:"Install AESM Service",id:"install-aesm-service",level:2},{value:"Ubuntu 20.04/18.04/16.04",id:"ubuntu-200418041604",level:3},{value:"Docker-enabled System",id:"docker-enabled-system",level:3},{value:"Podman-enabled System",id:"podman-enabled-system",level:3},{value:"Check SGX Setup",id:"check-sgx-setup",level:2},{value:"Install Dependencies",id:"install-dependencies",level:3},{value:"Install Rust Nightly",id:"install-rust-nightly",level:3},{value:"Build and Install sgxs-tools",id:"build-and-install-sgxs-tools",level:3},{value:"Run <code>sgx-detect</code> Tool",id:"run-sgx-detect-tool",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Missing <code>libsgx-aesm-epid-plugin</code>",id:"missing-libsgx-aesm-epid-plugin",level:3},{value:"Permission Denied When Accessing SGX Kernel Device",id:"permission-denied-when-accessing-sgx-kernel-device",level:3},{value:"Error Opening SGX Kernel Device",id:"error-opening-sgx-kernel-device",level:3},{value:"Unable to Launch Enclaves",id:"unable-to-launch-enclaves",level:3}],c={toc:u};function m(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"set-up-trusted-execution-environment-tee"},"Set up Trusted Execution Environment (TEE)"),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"In case the ParaTime you want to run does not require the use of a TEE (e.g.\nIntel SGX), you can skip setting up a TEE."))),(0,o.kt)("p",null,"If the ParaTime is configured to run in a TEE (currently only ",(0,o.kt)("a",{parentName:"p",href:"https://www.intel.com/content/www/us/en/architecture-and-technology/software-guard-extensions.html"},"Intel SGX"),"), you\nmust make sure that your system supports running SGX enclaves. This requires\nthat your hardware has SGX support, that SGX support is enabled and that the\nadditional driver and software components are properly installed and running."),(0,o.kt)("h2",{id:"ensure-clock-synchronization"},"Ensure Clock Synchronization"),(0,o.kt)("p",null,"Due to additional sanity checks within runtime enclaves, you should ensure that\nthe node's local clock is synchronized (e.g. using NTP). Otherwise you may\nexperience unexpected runtime aborts."),(0,o.kt)("h2",{id:"install-sgx-linux-driver"},"Install SGX Linux Driver"),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"In case you are running Linux kernel version 5.11 or higher, the required SGX\ndriver is already included and no additional installation is needed so you may\nskip this section."))),(0,o.kt)("p",null,"On older distributions see below for instructions on how to install the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/intel/linux-sgx-driver"},"legacy (out-of-tree) driver"),"."),(0,o.kt)("h3",{id:"ubuntu-18041604"},"Ubuntu 18.04/16.04"),(0,o.kt)("p",null,"A convenient way to install the SGX Linux driver on Ubuntu 18.04/16.04 systems\nis to use the ",(0,o.kt)("a",{parentName:"p",href:"https://edp.fortanix.com/docs/installation/guide/"},"Fortanix"),"'s\nAPT repository and its ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Dynamic_Kernel_Module_Support"},"DKMS"),"\npackage."),(0,o.kt)("p",null,"First add Fortanix's APT repository to your system:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'echo "deb https://download.fortanix.com/linux/apt xenial main" | sudo tee /etc/apt/sources.list.d/fortanix.list >/dev/null\ncurl -sSL "https://download.fortanix.com/linux/apt/fortanix.gpg" | sudo -E apt-key add -\n')),(0,o.kt)("p",null,"And then install the ",(0,o.kt)("inlineCode",{parentName:"p"},"intel-sgx-dkms")," package:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt update\nsudo apt install intel-sgx-dkms\n")),(0,o.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Some ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/confidential-computing/quick-create-portal"},"Azure Confidential Computing instances"),"\nhave the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/intel/SGXDataCenterAttestationPrimitives/tree/master/driver/linux"},"Intel SGX DCAP driver"),"\npre-installed."),(0,o.kt)("p",{parentName:"div"},"To determine that, run ",(0,o.kt)("inlineCode",{parentName:"p"},"dmesg | grep -i sgx")," and observe if a line like the\nfollowing is shown:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre"},"[    4.991649] sgx: intel_sgx: Intel SGX DCAP Driver v1.33\n")),(0,o.kt)("p",{parentName:"div"},"If that is the case, you need to blacklist the Intel SGX DCAP driver's module by\nrunning:"),(0,o.kt)("pre",{parentName:"div"},(0,o.kt)("code",{parentName:"pre"},'echo "blacklist intel_sgx" | sudo tee -a /etc/modprobe.d/blacklist-intel_sgx.conf >/dev/null\n')))),(0,o.kt)("h3",{id:"fedora-3433"},"Fedora 34/33"),(0,o.kt)("p",null,"A convenient way to install the SGX Linux driver on Fedora 34/33 systems is to\nuse the Oasis-provided ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/oasisprotocol/sgx-driver-kmod"},"Fedora Package for the Legacy Intel SGX Linux Driver"),"."),(0,o.kt)("h3",{id:"other-distributions"},"Other Distributions"),(0,o.kt)("p",null,"Go to ",(0,o.kt)("a",{parentName:"p",href:"https://01.org/intel-software-guard-extensions/downloads"},"Intel SGX Downloads"),'\npage and find the latest "Intel SGX Linux Release" (',(0,o.kt)("em",{parentName:"p"},"not"),' "Intel SGX DCAP\nRelease") and download the "Intel (R) SGX Installers" for your distribution. The\npackage will have ',(0,o.kt)("inlineCode",{parentName:"p"},"driver")," in the name (e.g., ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx_linux_x64_driver_2.11.0_2d2b795.bin"),")."),(0,o.kt)("h3",{id:"verification"},"Verification"),(0,o.kt)("p",null,"After installing the driver and restarting your system, make sure that the one\nof the SGX devices exists (the exact device name depends on which driver is\nbeing used):"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"/dev/sgx_enclave")," (since Linux kernel 5.11)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"/dev/isgx")," (legacy driver)")),(0,o.kt)("h2",{id:"ensure-dev-is-not-mounted-with-the-noexec-option"},"Ensure ",(0,o.kt)("inlineCode",{parentName:"h2"},"/dev")," is NOT Mounted with the ",(0,o.kt)("inlineCode",{parentName:"h2"},"noexec")," Option"),(0,o.kt)("p",null,"Some Linux distributions mount ",(0,o.kt)("inlineCode",{parentName:"p"},"/dev")," with the ",(0,o.kt)("inlineCode",{parentName:"p"},"noexec")," mount option. If that is\nthe case, it will prevent the enclave loader from mapping executable pages."),(0,o.kt)("p",null,"Ensure your ",(0,o.kt)("inlineCode",{parentName:"p"},"/dev")," (i.e. ",(0,o.kt)("inlineCode",{parentName:"p"},"devtmpfs"),") is not mounted with the ",(0,o.kt)("inlineCode",{parentName:"p"},"noexec")," option.\nTo check that, use:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cat /proc/mounts | grep devtmpfs\n")),(0,o.kt)("p",null,"To temporarily remove the ",(0,o.kt)("inlineCode",{parentName:"p"},"noexec")," mount option for ",(0,o.kt)("inlineCode",{parentName:"p"},"/dev"),", run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo mount -o remount,exec /dev\n")),(0,o.kt)("p",null,"To permanently remove the ",(0,o.kt)("inlineCode",{parentName:"p"},"noexec")," mount option for ",(0,o.kt)("inlineCode",{parentName:"p"},"/dev"),", add the following to\nthe system's ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/fstab")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"devtmpfs        /dev        devtmpfs    defaults,exec 0 0\n")),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"This is the recommended way to modify mount options for virtual (i.e. API) file\nsystem as described in ",(0,o.kt)("a",{parentName:"p",href:"https://www.freedesktop.org/wiki/Software/systemd/APIFileSystems/"},"systemd's API File Systems"),"\ndocumentation."))),(0,o.kt)("h2",{id:"install-aesm-service"},"Install AESM Service"),(0,o.kt)("p",null,"To allow execution of SGX enclaves, several ",(0,o.kt)("strong",{parentName:"p"},"Architectural Enclaves (AE)")," are\ninvolved (i.e. Launch Enclave, Provisioning Enclave, Provisioning Certificate\nEnclave, Quoting Enclave, Platform Services Enclaves)."),(0,o.kt)("p",null,"Communication between application-spawned SGX enclaves and Intel-provided\nArchitectural Enclaves is through ",(0,o.kt)("strong",{parentName:"p"},"Application Enclave Service Manager\n(AESM)"),". AESM runs as a daemon and provides a socket through which applications\ncan facilitate various SGX services such as launch approval, remote attestation\nquote signing, etc."),(0,o.kt)("h3",{id:"ubuntu-200418041604"},"Ubuntu 20.04/18.04/16.04"),(0,o.kt)("p",null,"A convenient way to install the AESM service on Ubuntu 20.04/18.04/16.04 systems\nis to use the Intel's ",(0,o.kt)("a",{parentName:"p",href:"https://download.01.org/intel-sgx/sgx_repo/"},"official Intel SGX APT repository"),"."),(0,o.kt)("p",null,"First add Intel SGX APT repository to your system:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'echo "deb https://download.01.org/intel-sgx/sgx_repo/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/intel-sgx.list >/dev/null\ncurl -sSL "https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key" | sudo -E apt-key add -\n')),(0,o.kt)("p",null,"And then install the ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-aesm-service"),",  ",(0,o.kt)("inlineCode",{parentName:"p"},"libsgx-aesm-launch-plugin")," and\n",(0,o.kt)("inlineCode",{parentName:"p"},"libsgx-aesm-epid-plugin")," packages:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt update\nsudo apt install sgx-aesm-service libsgx-aesm-launch-plugin libsgx-aesm-epid-plugin\n")),(0,o.kt)("p",null,"The AESM service should be up and running. To confirm that, use:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl status aesmd.service\n")),(0,o.kt)("h3",{id:"docker-enabled-system"},"Docker-enabled System"),(0,o.kt)("p",null,"An easy way to install and run the AESM service on a ",(0,o.kt)("a",{parentName:"p",href:"https://docs.docker.com/engine/"},"Docker"),"-enabled\nsystem is to use ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/oasisprotocol/aesmd/"},"our AESM container image"),"."),(0,o.kt)("p",null,"Executing the following command should (always) pull the latest version of our\nAESM Docker container, map the SGX devices and ",(0,o.kt)("inlineCode",{parentName:"p"},"/var/run/aesmd")," directory and\nensure AESM is running in the background (also automatically started on boot):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker run \\\n  --pull always \\\n  --detach \\\n  --restart always \\\n  --device /dev/sgx_enclave \\\n  --device /dev/sgx_provision \\\n  --volume /var/run/aesmd:/var/run/aesmd \\\n  --name aesmd \\\n  oasisprotocol/aesmd:master\n")),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Make sure to use the correct devices based on your ",(0,o.kt)("a",{parentName:"p",href:"/general/run-a-node/prerequisites/set-up-trusted-execution-environment-tee#verification"},"kernel version"),".\nThe example above assumes the use of the newer driver which uses two devices.\nFor the legacy driver you need to specify ",(0,o.kt)("inlineCode",{parentName:"p"},"--device /dev/isgx")," instead."))),(0,o.kt)("h3",{id:"podman-enabled-system"},"Podman-enabled System"),(0,o.kt)("p",null,"Similarly to Docker-enabled systems, an easy way to install and run the AESM\nservice on a ",(0,o.kt)("a",{parentName:"p",href:"https://podman.io"},"Podman"),"-enabled system is to use\n",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/oasisprotocol/aesmd/"},"our AESM container image"),"."),(0,o.kt)("p",null,"First, create the container with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo podman create \\\n  --pull always \\\n  --device /dev/sgx_enclave \\\n  --device /dev/sgx_provision \\\n  --volume /var/run/aesmd:/var/run/aesmd:Z \\\n  --name aesmd \\\n  docker.io/oasisprotocol/aesmd\n")),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"Make sure to use the correct devices based on your ",(0,o.kt)("a",{parentName:"p",href:"/general/run-a-node/prerequisites/set-up-trusted-execution-environment-tee#verification"},"kernel version"),".\nThe example above assumes the use of the newer driver which uses two devices.\nFor the legacy driver you need to specify ",(0,o.kt)("inlineCode",{parentName:"p"},"--device /dev/isgx")," instead."))),(0,o.kt)("p",null,"Then generate the ",(0,o.kt)("inlineCode",{parentName:"p"},"container-aesmd.service")," systemd unit file for it with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'sudo podman generate systemd --restart-policy=always --time 10 --name aesmd | \\\n  sed "/\\[Service\\]/a RuntimeDirectory=aesmd" | \\\n  sudo tee /etc/systemd/system/container-aesmd.service\n')),(0,o.kt)("p",null,"Finally, enable and start the ",(0,o.kt)("inlineCode",{parentName:"p"},"container-aesmd.service")," with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl enable container-aesmd.service\nsudo systemctl start container-aesmd.service\n")),(0,o.kt)("p",null,"The AESM service should be up and running. To confirm that, use:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl status container-aesmd.service\n")),(0,o.kt)("p",null,"To see the logs of the AESM service, use:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo podman logs -t -f aesmd\n")),(0,o.kt)("h2",{id:"check-sgx-setup"},"Check SGX Setup"),(0,o.kt)("p",null,"In order to make sure that your SGX setup is working, you can use the\n",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect")," tool from the ",(0,o.kt)("a",{parentName:"p",href:"https://lib.rs/crates/sgxs-tools"},"sgxs-tools")," Rust\npackage."),(0,o.kt)("p",null,"There are no pre-built packages for it, so you will need to compile it yourself."),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"sgxs-tools must be compiled with a nightly version of the Rust toolchain since\nthey use the ",(0,o.kt)("inlineCode",{parentName:"p"},"#![feature]")," macro."))),(0,o.kt)("h3",{id:"install-dependencies"},"Install Dependencies"),(0,o.kt)("p",null,"Make sure you have the following installed on your system:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://gcc.gnu.org"},"GCC"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/protocolbuffers/protobuf"},"Protobuf")," compiler."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.freedesktop.org/wiki/Software/pkg-config"},"pkg-config"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.openssl.org"},"OpenSSL")," development package.")),(0,o.kt)("p",null,"On Fedora, you can install all the above with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo dnf install gcc protobuf-compiler pkg-config openssl-devel\n")),(0,o.kt)("p",null,"On Ubuntu, you can install all the above with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo apt install gcc protobuf-compiler pkg-config libssl-dev\n")),(0,o.kt)("h3",{id:"install-rust-nightly"},"Install ",(0,o.kt)("a",{parentName:"h3",href:"https://www.rust-lang.org"},"Rust")," Nightly"),(0,o.kt)("p",null,"We follow ",(0,o.kt)("a",{parentName:"p",href:"https://www.rust-lang.org/tools/install"},"Rust upstream's recommendation"),"\non using ",(0,o.kt)("a",{parentName:"p",href:"https://rustup.rs"},"rustup")," to install and manage Rust versions."),(0,o.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"rustup cannot be installed alongside a distribution packaged Rust version. You\nwill need to remove it (if it's present) before you can start using rustup."))),(0,o.kt)("p",null,"Install rustup by running:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh\n")),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If you want to avoid directly executing a shell script fetched the internet, you\ncan also ",(0,o.kt)("a",{parentName:"p",href:"https://rust-lang.github.io/rustup/installation/other.html"},"download ",(0,o.kt)("inlineCode",{parentName:"a"},"rustup-init")," executable for your platform"),"\nand run it manually. This will run ",(0,o.kt)("inlineCode",{parentName:"p"},"rustup-init")," which will download and install\nthe latest stable version of Rust on your system."))),(0,o.kt)("p",null,"Install Rust nightly with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"rustup install nightly-2021-11-04\n")),(0,o.kt)("h3",{id:"build-and-install-sgxs-tools"},"Build and Install sgxs-tools"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cargo +nightly-2021-11-04 install sgxs-tools\n")),(0,o.kt)("h3",{id:"run-sgx-detect-tool"},"Run ",(0,o.kt)("inlineCode",{parentName:"h3"},"sgx-detect")," Tool"),(0,o.kt)("p",null,"After the installation completes, run ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect")," to make sure that everything\nis set up correctly:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo $(which sgx-detect)\n")),(0,o.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"If you don't run the ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect")," tool as ",(0,o.kt)("inlineCode",{parentName:"p"},"root"),", it might not have the\nnecessary permissions to access the SGX kernel device."))),(0,o.kt)("p",null,"When everything works, you should get output similar to the following (some\nthings depend on hardware features so your output may differ):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Detecting SGX, this may take a minute...\n\u2714  SGX instruction set\n  \u2714  CPU support\n  \u2714  CPU configuration\n  \u2714  Enclave attributes\n  \u2714  Enclave Page Cache\n  SGX features\n    \u2714  SGX2  \u2714  EXINFO  \u2714  ENCLV  \u2714  OVERSUB  \u2714  KSS\n    Total EPC size: 92.8MiB\n\u2718  Flexible launch control\n  \u2714  CPU support\n  \uff1f CPU configuration\n  \u2718  Able to launch production mode enclave\n\u2714  SGX system software\n  \u2714  SGX kernel device (/dev/isgx)\n  \u2718  libsgx_enclave_common\n  \u2714  AESM service\n  \u2714  Able to launch enclaves\n    \u2714  Debug mode\n    \u2718  Production mode\n    \u2714  Production mode (Intel whitelisted)\n")),(0,o.kt)("p",null,"The important part is the checkbox under ",(0,o.kt)("em",{parentName:"p"},"Able to launch enclaves")," in both\n",(0,o.kt)("em",{parentName:"p"},"Debug mode")," and ",(0,o.kt)("em",{parentName:"p"},"Production mode (Intel whitelisted)"),"."),(0,o.kt)("p",null,"In case you encounter errors, see the ",(0,o.kt)("a",{parentName:"p",href:"https://edp.fortanix.com/docs/installation/help/"},"list of common SGX installation issues"),"\nfor help."),(0,o.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"See  ",(0,o.kt)("a",{parentName:"p",href:"/general/run-a-node/troubleshooting"},"the general troubleshooting section"),", before\nproceeding with ParaTime node-specific troubleshooting."),(0,o.kt)("h3",{id:"missing-libsgx-aesm-epid-plugin"},"Missing ",(0,o.kt)("inlineCode",{parentName:"h3"},"libsgx-aesm-epid-plugin")),(0,o.kt)("p",null,"If you are encountering the following error message in your node's logs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"failed to initialize TEE: error while getting quote info from AESMD: aesm: error 30\n")),(0,o.kt)("p",null,"Ensure you have all required SGX driver libraries installed as listed in\n",(0,o.kt)("a",{parentName:"p",href:"/general/run-a-node/set-up-your-node/run-a-paratime-node#install-sgx-linux-driver"},"Install SGX Linux Driver section"),".\nPrevious versions of this guide were missing the ",(0,o.kt)("inlineCode",{parentName:"p"},"libsgx-aesm-epid-plugin"),"."),(0,o.kt)("h3",{id:"permission-denied-when-accessing-sgx-kernel-device"},"Permission Denied When Accessing SGX Kernel Device"),(0,o.kt)("p",null,"If running ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect --verbose")," reports:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\ud83d\udd6e  SGX system software > SGX kernel device\nPermission denied while opening the SGX device (/dev/sgx/enclave, /dev/sgx or\n/dev/isgx). Make sure you have the necessary permissions to create SGX enclaves.\nIf you are running in a container, make sure the device permissions are\ncorrectly set on the container.\n\ndebug: Error opening device: Permission denied (os error 13)\ndebug: cause: Permission denied (os error 13)\n")),(0,o.kt)("p",null,"Ensure you are running the ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect")," tool as ",(0,o.kt)("inlineCode",{parentName:"p"},"root")," via:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sudo $(which sgx-detect) --verbose\n")),(0,o.kt)("h3",{id:"error-opening-sgx-kernel-device"},"Error Opening SGX Kernel Device"),(0,o.kt)("p",null,"If running ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect --verbose")," reports:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'\ud83d\udd6e  SGX system software > SGX kernel device\nThe SGX device (/dev/sgx/enclave, /dev/sgx or /dev/isgx) could not be opened:\n"/dev" mounted with `noexec` option.\n\ndebug: Error opening device: "/dev" mounted with `noexec` option\ndebug: cause: "/dev" mounted with `noexec` option\n')),(0,o.kt)("p",null,"Ensure your system's ",(0,o.kt)("a",{parentName:"p",href:"#ensure-dev-is-not-mounted-with-the-noexec-option"},(0,o.kt)("inlineCode",{parentName:"a"},"/dev")," is NOT mounted with the ",(0,o.kt)("inlineCode",{parentName:"a"},"noexec")," mount option"),"."),(0,o.kt)("h3",{id:"unable-to-launch-enclaves"},"Unable to Launch Enclaves"),(0,o.kt)("p",null,"If running ",(0,o.kt)("inlineCode",{parentName:"p"},"sgx-detect --verbose")," reports:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\ud83d\udd6e  SGX system software > Able to launch enclaves > Debug mode\nThe enclave could not be launched.\n\ndebug: failed to load report enclave\ndebug: cause: failed to load report enclave\ndebug: cause: Failed to map enclave into memory.\ndebug: cause: Operation not permitted (os error 1)\n")),(0,o.kt)("p",null,"Ensure your system's ",(0,o.kt)("a",{parentName:"p",href:"#ensure-dev-is-not-mounted-with-the-noexec-option"},(0,o.kt)("inlineCode",{parentName:"a"},"/dev")," is NOT mounted with the ",(0,o.kt)("inlineCode",{parentName:"a"},"noexec")," mount option"),"."))}m.isMDXComponent=!0}}]);